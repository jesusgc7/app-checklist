<!-- ... existing code ... -->
            const renderAllShipments = (shipments) => {
                const pendingShipments = shipments.filter(s => !s.boxes.every(b => b.delivered));
                const completedShipments = shipments.filter(s => s.boxes.every(b => b.delivered));
                elements.pendingCount.textContent = pendingShipments.length;
                elements.completedCount.textContent = completedShipments.length;
                renderShipmentList(pendingShipments, elements.pendingContent, 'No hay envíos pendientes.');
                renderShipmentList(completedShipments, elements.completedContent, 'No hay envíos completados.');
                elements.managementSection.style.display = shipments.length > 0 ? 'block' : 'none';
            };
            
            const renderShipmentList = (shipmentList, container, emptyText) => {
                container.innerHTML = '';
                if (shipmentList.length === 0) {
                    container.innerHTML = `<p class="text-center text-gray-500 py-8 text-xl">${emptyText}</p>`; return;
                }
                // --- CAMBIO: Lógica de ordenación ---
                // Ahora ordena por fecha de creación (los más nuevos primero).
                // Si un envío no tiene fecha de creación (es antiguo), se usa la fecha de envío como alternativa.
                shipmentList.sort((a, b) => {
                    const timeA = a.createdAt && a.createdAt.toDate ? a.createdAt.toDate().getTime() : 0;
                    const timeB = b.createdAt && b.createdAt.toDate ? b.createdAt.toDate().getTime() : 0;
                    if (timeB > timeA) return 1;
                    if (timeB < timeA) return -1;
                    return b.sortableDate.localeCompare(a.sortableDate);
                });
                const sevenDaysAgo = Date.now() - 7 * 24 * 60 * 60 * 1000;
                shipmentList.forEach(shipment => {
                    const hasValidTimestamp = shipment.lastUpdated && typeof shipment.lastUpdated.toDate === 'function';
<!-- ... existing code ... -->
            const handleFileSelect = async (event) => {
                const files = event.target.files; if (!files || !files.length || !shipmentsCollectionRef) return;
                toggleLoader(true, `Procesando ${files.length} archivo(s)...`);
                for (const file of files) {
                    try {
                        const data = await extractDataFromPdf(file);
                        if (localShipmentsCache.some(s => s.id === data.shippingOrderId)) continue;
                        const newShipment = {
                            id: data.shippingOrderId, orderDescription: data.orderDescription, type: data.type,
                            fileName: file.name, shippingDate: data.shippingDate, totalPieces: data.totalPieces, weight: data.weight,
                            sortableDate: data.shippingDate.split('/').reverse().join('-'),
                            boxes: data.boxIds.map(id => ({ id, delivered: false })), 
                            lastUpdated: window.firebaseSDK.serverTimestamp(),
                            createdAt: window.firebaseSDK.serverTimestamp() // <-- NUEVO: Guarda la fecha de creación
                        };
                        await window.firebaseSDK.addDoc(shipmentsCollectionRef, newShipment);
                    } catch (error) { console.error(error); }
                }
<!-- ... existing code ... -->
