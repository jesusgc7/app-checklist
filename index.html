<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestión de Recepción - ExtremaduraSport</title>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Titillium+Web:wght@400;600;700;900&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>

    <script type="module" src="https://cdn.jsdelivr.net/npm/@material/web/all.js?module"></script>
    
    <style>
        :root {
            /* Paleta de Material 3 (Ejemplo) */
            --md-sys-color-primary: #006a6a;
            --md-sys-color-on-primary: #ffffff;
            --md-sys-color-primary-container: #9cf2f1;
            --md-sys-color-on-primary-container: #002020;
            --md-sys-color-secondary: #4a6363;
            --md-sys-color-on-secondary: #ffffff;
            --md-sys-color-secondary-container: #cde8e7;
            --md-sys-color-on-secondary-container: #051f1f;
            --md-sys-color-error: #ba1a1a;
            --md-sys-color-on-error: #ffffff;
            --md-sys-color-error-container: #ffdad6;
            --md-sys-color-on-error-container: #410002;
            --md-sys-color-background: #f4fcfc;
            --md-sys-color-on-background: #161c1c;
            --md-sys-color-surface: #f4fcfc;
            --md-sys-color-on-surface: #161c1c;
            --md-sys-color-surface-variant: #dae5e4;
            --md-sys-color-on-surface-variant: #3f4948;
            --md-sys-color-outline: #6f7978;
            --md-sys-color-surface-container-highest: #e0e3e2;
            --md-sys-color-surface-bright: #f4fcfc;

            /* Aplicar fuente base */
            font-family: 'Roboto', sans-serif;
            background-color: var(--md-sys-color-background);
            color: var(--md-sys-color-on-background);
        }

        body {
            margin: 0;
            padding: 0;
        }
        
        /* Contenedor principal para el layout con Top-App-Bar */
        .main-layout {
            display: flex;
            flex-direction: column;
            height: 100vh;
        }

        md-top-app-bar {
            --md-sys-color-primary: #111827; /* Header oscuro */
            --md-sys-color-on-primary: #ffffff;
            position: sticky;
            top: 0;
            z-index: 100;
        }
        
        .app-title {
            font-family: 'Titillium Web', sans-serif;
            font-weight: 900;
            font-style: italic;
            letter-spacing: 0.05em;
        }
        
        .app-subtitle {
             font-family: 'Titillium Web', sans-serif;
             font-size: 0.8rem;
             font-weight: 600;
             text-transform: uppercase;
             color: var(--md-sys-color-on-surface-variant);
             text-align: center;
             margin-top: -8px;
        }

        main {
            flex-grow: 1;
            overflow-y: auto;
            padding: 16px;
            padding-bottom: 80px; /* Espacio para barra de gestión */
        }
        
        /* Vistas de la App */
        .app-view { display: none; }
        .app-view.active { display: block; }
        
        /* Contenedores */
        .view-container, .card-container {
            max-width: 900px;
            margin: 0 auto;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        
        .filter-card, .upload-card {
            padding: 16px;
            border: 1px solid var(--md-sys-color-outline);
            border-radius: 12px;
            background-color: var(--md-sys-color-surface-bright);
        }
        
        h2.card-title {
            font-family: 'Titillium Web', sans-serif;
            font-size: 1.5rem;
            font-weight: 700;
            margin: 0 0 16px 0;
            color: var(--md-sys-color-primary);
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }
        
        md-filled-button, md-outlined-button, md-text-button {
            width: 100%;
        }
        
        .button-group {
            display: flex;
            gap: 16px;
        }

        /* Estilos de la lista de envíos */
        .shipment-list {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }
        
        .date-header {
            font-family: 'Titillium Web', sans-serif;
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--md-sys-color-on-background);
            border-bottom: 2px solid var(--md-sys-color-primary-container);
            padding-bottom: 8px;
            margin-top: 16px;
        }
        
        .shipment-card {
            --md-elevation-level: 1;
            border-radius: 12px;
            background-color: var(--md-sys-color-surface-bright);
            overflow: hidden;
            display: flex;
            border-left: 4px solid var(--md-sys-color-surface-variant);
            transition: all 0.3s ease;
        }
        
        .shipment-card.is-selected {
            border-left-color: var(--md-sys-color-primary);
            background-color: var(--md-sys-color-primary-container);
        }
        
        .shipment-card.is-overdue {
            border-left-color: var(--md-sys-color-error);
            background-color: var(--md-sys-color-error-container);
        }
        
        .shipment-card-content {
            padding: 16px;
            flex-grow: 1;
        }

        .shipment-card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            gap: 16px;
            padding-bottom: 12px;
            border-bottom: 1px solid var(--md-sys-color-surface-container-highest);
            margin-bottom: 12px;
        }
        
        .shipment-card-title {
            font-size: 1.1rem;
            font-weight: 700;
            margin: 0;
        }
        
        .shipment-card-subtitle, .shipment-card-filename {
            font-size: 0.8rem;
            color: var(--md-sys-color-on-surface-variant);
            margin: 0;
        }
        
        .shipment-card-tags {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 8px;
            flex-shrink: 0;
        }
        
        .chip {
            font-size: 0.75rem;
            font-weight: 500;
            padding: 4px 10px;
            border-radius: 16px;
        }
        
        .chip-progress {
            background-color: var(--md-sys-color-secondary-container);
            color: var(--md-sys-color-on-secondary-container);
        }

        .chip-completed {
            background-color: #C8E6C9; /* Verde (no en M3 por defecto) */
            color: #1B5E20;
        }
        
        .chip-type-b2b {
            background-color: #D1C4E9; /* Morado */
            color: #311B92;
        }
        
        .chip-type-pack {
            background-color: #BBDEFB; /* Azul */
            color: #0D47A1;
        }
        
        .overdue-text {
            font-size: 0.8rem;
            font-weight: 700;
            color: var(--md-sys-color-error);
            margin-top: 8px;
        }

        .box-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .box-item {
            display: flex;
            align-items: flex-start;
            gap: 12px;
            padding: 12px;
            border-radius: 8px;
            transition: background-color 0.3s ease;
        }
        
        .box-item:not(.is-delete-mode) {
             cursor: pointer;
        }
        
         .box-item:not(.is-delete-mode):hover {
            background-color: var(--md-sys-color-surface-container-highest);
         }
        
        .box-item.is-delivered {
            background-color: #f5f5f5;
            color: var(--md-sys-color-on-surface-variant);
        }
        
        .box-item md-checkbox {
            margin-top: 4px; /* Alinear con el texto */
        }
        
        .box-item-details {
            flex-grow: 1;
            font-family: 'Roboto Mono', monospace;
            text-decoration: none;
        }
        
        .box-item.is-delivered .box-item-details {
            text-decoration: line-through;
        }
        
        .box-item-id {
            font-weight: 700;
            font-size: 1.1rem;
            color: var(--md-sys-color-on-surface);
        }

        .box-item-list {
            list-style: disc;
            margin: 4px 0 0 20px;
            padding: 0;
            font-size: 0.85rem;
            color: var(--md-sys-color-on-surface-variant);
        }

        /* Loader y Modales */
        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            background-color: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(4px);
            color: white;
            transition: opacity 0.3s ease;
            opacity: 0;
            pointer-events: none;
        }
        
        .overlay.active {
            opacity: 1;
            pointer-events: all;
        }
        
        .overlay md-circular-progress {
            --md-circular-progress-size: 60px;
            --md-sys-color-primary: #ffffff;
        }
        
        .overlay p {
            font-size: 1.1rem;
            font-weight: 500;
            margin-top: 16px;
        }

        md-dialog {
            --md-dialog-container-color: var(--md-sys-color-surface-bright);
        }
        
        #city-selector-dialog md-dialog {
             --md-dialog-container-color: #111827;
        }
        
        .city-selector-content {
            display: flex;
            flex-direction: column;
            gap: 16px;
            padding: 24px;
        }

        .city-selector-content h1 {
            font-family: 'Titillium Web', sans-serif;
            font-weight: 900;
            font-style: italic;
            font-size: 2.5rem;
            text-align: center;
            color: white;
            margin: 0;
        }
        
        .city-selector-content p {
            font-size: 1.2rem;
            text-align: center;
            color: var(--md-sys-color-surface-variant);
            margin: 0 0 16px 0;
        }
        
        .city-selector-content md-filled-button {
            --md-sys-color-primary: #ffffff;
            --md-sys-color-on-primary: #111827;
            --md-filled-button-label-text-size: 1.25rem;
            --md-filled-button-container-height: 60px;
            width: 300px;
        }

        /* Menú lateral */
        md-navigation-drawer {
            --md-navigation-drawer-container-color: var(--md-sys-color-surface-bright);
        }
        
        .menu-header {
            font-family: 'Titillium Web', sans-serif;
            font-size: 1.5rem;
            font-weight: 700;
            padding: 24px 16px 16px 16px;
        }
        
        .menu-subheader {
            font-size: 0.75rem;
            font-weight: 700;
            text-transform: uppercase;
            color: var(--md-sys-color-on-surface-variant);
            padding: 16px 16px 8px 16px;
        }
        
        md-list-item span[slot="start"] {
            display: flex;
            align-items: center;
        }

        .count-badge {
            font-size: 0.8rem;
            font-weight: 700;
            padding: 2px 8px;
            border-radius: 12px;
            margin-left: 8px;
        }
        .count-badge.pending { background-color: #FFECB3; color: #664E00; }
        .count-badge.partial { background-color: #FFF9C4; color: #5F4300; }
        .count-badge.completed { background-color: #C8E6C9; color: #1B5E20; }
        
        .menu-footer {
            padding: 16px;
            margin-top: auto;
        }
        
        /* Barra de gestión */
        #delete-controls {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            background-color: var(--md-sys-color-surface-container-highest);
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 16px;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
            transform: translateY(100%);
            transition: transform 0.3s ease-in-out;
            z-index: 50;
        }
        
        #delete-controls.active {
            transform: translateY(0);
        }
        
        #delete-controls .button-group {
            flex-shrink: 0;
            width: auto;
        }
        
        #delete-controls md-filled-tonal-button, 
        #delete-controls md-filled-button {
             width: auto;
        }
        
        #delete-controls md-filled-button {
            --md-sys-color-primary: var(--md-sys-color-error);
            --md-sys-color-on-primary: var(--md-sys-color-on-error);
        }
        
        /* Feedback de escaneo */
        #scan-feedback-overlay {
            color: white;
            text-align: center;
        }
        #scan-feedback-order { font-size: 2rem; font-weight: 700; margin: 0; }
        #scan-feedback-digits { font-family: 'Titillium Web', sans-serif; font-weight: 900; font-size: 7rem; margin: 0; }
        #scan-feedback-type { font-size: 1.5rem; font-weight: 500; margin: 0; }
        #scan-feedback-items {
             margin-top: 24px;
             padding: 16px;
             border-radius: 12px;
             background-color: rgba(0,0,0,0.2);
             max-width: 400px;
        }
         #scan-feedback-items ul { list-style-type: none; padding: 0; margin: 0; }
         #scan-feedback-items li { font-size: 1.1rem; }
    </style>
</head>
<body>

    <div id="city-selector-dialog-container">
        <md-dialog id="city-selector-dialog" open modal>
            <div class="city-selector-content">
                <h1>ExtremaduraSport</h1>
                <p>Selecciona una sede para continuar</p>
                <md-filled-button id="caceres-btn" data-city="Cáceres">Cáceres</md-filled-button>
                <md-filled-button id="badajoz-btn" data-city="Badajoz">Badajoz</md-filled-button>
            </div>
        </md-dialog>
    </div>

    <div id="app-wrapper" class="main-layout" style="display: none;">

        <md-navigation-drawer type="modal" id="side-menu">
            <h2 class="menu-header">Menú</h2>
            <md-list>
                <div class="menu-subheader">Vistas</div>
                <md-list-item id="nav-checklist" data-view="checklist" headline="Recepción" class="nav-link" active>
                    <span slot="start" class="material-icons">inventory_2</span>
                </md-list-item>
                <md-list-item id="nav-scanner" data-view="scanner" headline="Escáner de Cajas" class="nav-link">
                    <span slot="start" class="material-icons">qr_code_scanner</span>
                </md-list-item>
                
                <md-divider></md-divider>
                
                <div class="menu-subheader">Filtros de Estado</div>
                <div id="status-filters">
                    <md-list-item data-filter="pending" class="nav-link filter-link" active>
                        <span>Pendientes</span>
                        <span slot="end" id="pending-count" class="count-badge pending">0</span>
                    </md-list-item>
                    <md-list-item data-filter="partial" class="nav-link filter-link">
                        <span>Parcialmente Recibido</span>
                        <span slot="end" id="partial-count" class="count-badge partial">0</span>
                    </md-list-item>
                    <md-list-item data-filter="completed" class="nav-link filter-link">
                        <span>Completados</span>
                        <span slot="end" id="completed-count" class="count-badge completed">0</span>
                    </md-list-item>
                </div>
            </md-list>
            
            <div class="menu-footer">
                <md-outlined-button id="change-city-button">
                    Cambiar Sede
                    <span slot="icon" class="material-icons">location_city</span>
                </md-outlined-button>
            </div>
        </md-navigation-drawer>

        <md-top-app-bar>
            <md-icon-button id="open-menu-button" slot="navigationIcon">
                <span class="material-icons">menu</span>
            </md-icon-button>
            <div slot="headline" class="app-title">ExtremaduraSport</div>
            <div id="city-display" class="app-subtitle"></div>
            
            <md-icon-button id="notification-bell" slot="actionItems" style="position: relative;">
                <span class="material-icons">notifications</span>
                <md-badge id="notification-badge" style="display: none;"></md-badge>
            </md-icon-button>
            
            <md-menu id="notification-panel" anchor="notification-bell">
                 <div style="padding: 12px 16px; display: flex; justify-content: space-between; align-items: center; min-width: 300px;">
                    <h3 style="margin: 0; font-size: 1.1rem;">Notificaciones</h3>
                    <md-text-button id="clear-notifications-btn">Limpiar</md-text-button>
                 </div>
                 <md-divider></md-divider>
                 <div id="notification-list" style="max-height: 300px; overflow-y: auto;">
                    </div>
            </md-menu>
        </md-top-app-bar>

        <main>
            <div id="checklist-view" class="app-view active">
                <div class="view-container">
                    <div class="filter-card">
                        <div class="form-group">
                            <md-outlined-text-field id="item-search-input" label="Buscar Artículo" placeholder="Código (8000...) o descripción (WISP...)" type="search">
                                <span slot="leading-icon" class="material-icons">search</span>
                            </md-outlined-text-field>
                            
                            <md-outlined-text-field id="box-search-input" label="Buscar Envío por Caja" placeholder="4 últ. dígitos de caja (7000...)" type="search">
                                <span slot="leading-icon" class="material-icons">search</span>
                            </md-outlined-text-field>

                            <md-outlined-text-field id="date-filter-input" type="date"></md-outlined-text-field>
                            
                            <md-text-button id="clear-date-filter">
                                Limpiar Filtros
                                <span slot="icon" class="material-icons">clear_all</span>
                            </md-text-button>
                        </div>
                    </div>
                    
                    <div class="upload-card">
                         <h2 class="card-title">Cargar Documentos</h2>
                         <input type="file" accept=".pdf" id="file-input" class="hidden" multiple style="display: none;" />
                         <md-filled-button id="upload-button">
                             Cargar PDF(s)
                             <span slot="icon" class="material-icons">upload_file</span>
                         </md-filled-button>
                    </div>
                    
                    <md-tabs id="status-tabs" @change="">
                        <md-primary-tab data-filter="pending" active>Pendientes</md-primary-tab>
                        <md-primary-tab data-filter="partial">Parciales</md-primary-tab>
                        <md-primary-tab data-filter="completed">Completados</md-primary-tab>
                    </md-tabs>
                    
                    <div id="shipment-list-container" class="shipment-list">
                        </div>

                    <div id="management-section" style="display: none; margin-top: 24px; text-align: center;">
                        <md-text-button id="manage-shipments-button">
                            Gestionar Envíos
                             <span slot="icon" class="material-icons">delete_sweep</span>
                        </md-text-button>
                    </div>
                </div>
            </div>

            <div id="scanner-view" class="app-view">
                <div class="view-container">
                    <div class="upload-card">
                         <h2 class="card-title">Escáner de Cajas</h2>
                         <div class="form-group">
                            <md-outlined-text-field id="scanner-input" label="1. Escanear con lector externo" placeholder="Haz clic aquí y escanea un código...">
                            </md-outlined-text-field>
                            
                            <md-filled-button id="scanner-search-btn">
                                Buscar
                                <span slot="icon" class="material-icons">search</span>
                            </md-filled-button>
                            
                            <md-divider style="margin-top: 16px;"></md-divider>
                            
                            <p style="margin: 16px 0 0 0; font-weight: 500;">2. O escanear con la cámara:</p>
                            <md-filled-tonal-button id="camera-scan-btn">
                                Activar Cámara
                                <span slot="icon" class="material-icons">camera_alt</span>
                            </md-filled-tonal-button>
                            
                            <div id="camera-container" class="hidden" style="display: none; border-radius: 12px; overflow: hidden;">
                                <video id="camera-feed" style="width: 100%; height: auto;"></video>
                            </div>
                         </div>
                    </div>
                </div>
            </div>
        </main>
    </div>
    
    <div id="delete-controls">
         <span id="selection-counter" style="font-weight: 500;">0 seleccionados</span>
         <div class="button-group">
            <md-text-button id="cancel-delete-button">Cancelar</md-text-button>
            <md-filled-tonal-button id="select-all-button">Seleccionar Todo</md-filled-tonal-button>
            <md-filled-button id="delete-selected-button" disabled>Eliminar</md-filled-button>
         </div>
    </div>
    
    <md-dialog id="confirm-delete-modal">
        <div slot="headline">Confirmar Eliminación</div>
        <div slot="content" id="confirm-delete-text">
            ¿Estás seguro de que quieres eliminar los envíos seleccionados?
        </div>
        <div slot="actions">
            <md-text-button id="cancel-confirm-delete-btn" value="cancel">Cancelar</md-text-button>
            <md-text-button id="confirm-delete-btn" value="delete" style="color: var(--md-sys-color-error);">Sí, eliminar</md-text-button>
        </div>
    </md-dialog>

    <div id="loader-overlay" class="overlay">
        <md-circular-progress indeterminate></md-circular-progress>
        <p id="loader-text">Cargando...</p>
    </div>
    
    <div id="scan-feedback-overlay" class="overlay feedback-overlay">
        <p id="scan-feedback-order"></p>
        <p id="scan-feedback-digits"></p>
        <p id="scan-feedback-type"></s>
        <div id="scan-feedback-items"></div>
    </div>


    <script type="module">
        // --- Configuración de Firebase ---
        const firebaseConfig = {
            apiKey: "AIzaSyAqU_YVc5guelLqj5GZEWy_BVOkk8kmCLg",
            authDomain: "checklist-extremadura-sport.firebaseapp.com",
            projectId: "checklist-extremadura-sport",
            storageBucket: "checklist-extremadura-sport.firebasestorage.app",
            messagingSenderId: "315765310685",
            appId: "1:315765310685:web:1dff6bdc194d73b31ec734",
            measurementId: "G-MR874YTMB5"
        };

        // Imports de Firebase
        import { initializeApp, getApps, getApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, collection, onSnapshot, doc, updateDoc, deleteDoc, serverTimestamp, setLogLevel, writeBatch } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        
        // Import de ZXing
        import { BrowserMultiFormatReader, NotFoundException } from "https://cdn.jsdelivr.net/npm/@zxing/library@latest/+esm";

        document.addEventListener('DOMContentLoaded', () => {
            const APP_VERSION = "v7.0-MD3";
            let db; let shipmentsCollectionRef; let localShipmentsCache = [];
            let unsubscribeFromShipments; let currentCity = '';
            let isDeleteModeActive = false; let shipmentsToDelete = new Set(); 
            let initialClassifications = new Map();
            let currentStatusFilter = 'pending';
            let scanTimeout;
            const projectId = "extremadurasport-checklist"; 
            let codeReader; 
            let isCameraRunning = false;

            // Objeto de elementos de la UI de Material
            const elements = {
                citySelectorDialog: document.getElementById('city-selector-dialog'),
                appWrapper: document.getElementById('app-wrapper'),
                sideMenu: document.getElementById('side-menu'),
                openMenuButton: document.getElementById('open-menu-button'),
                changeCityButton: document.getElementById('change-city-button'),
                cityDisplay: document.getElementById('city-display'),
                uploadButton: document.getElementById('upload-button'),
                fileInput: document.getElementById('file-input'),
                loaderOverlay: document.getElementById('loader-overlay'),
                loaderText: document.getElementById('loader-text'),
                managementSection: document.getElementById('management-section'),
                manageShipmentsButton: document.getElementById('manage-shipments-button'),
                pendingCount: document.getElementById('pending-count'),
                partialCount: document.getElementById('partial-count'),
                completedCount: document.getElementById('completed-count'),
                shipmentListContainer: document.getElementById('shipment-list-container'),
                deleteControls: document.getElementById('delete-controls'),
                selectionCounter: document.getElementById('selection-counter'),
                deleteSelectedButton: document.getElementById('delete-selected-button'),
                cancelDeleteButton: document.getElementById('cancel-delete-button'),
                selectAllButton: document.getElementById('select-all-button'),
                confirmDeleteModal: document.getElementById('confirm-delete-modal'),
                confirmDeleteText: document.getElementById('confirm-delete-text'),
                confirmDeleteBtn: document.getElementById('confirm-delete-btn'),
                cancelConfirmDeleteBtn: document.getElementById('cancel-confirm-delete-btn'),
                boxSearchInput: document.getElementById('box-search-input'),
                itemSearchInput: document.getElementById('item-search-input'),
                statusTabs: document.getElementById('status-tabs'),
                statusFilters: document.getElementById('status-filters'), // En el menú
                notificationBell: document.getElementById('notification-bell'),
                notificationBadge: document.getElementById('notification-badge'),
                notificationPanel: document.getElementById('notification-panel'),
                notificationList: document.getElementById('notification-list'),
                clearNotificationsBtn: document.getElementById('clear-notifications-btn'),
                navChecklist: document.getElementById('nav-checklist'),
                navScanner: document.getElementById('nav-scanner'),
                checklistView: document.getElementById('checklist-view'),
                scannerView: document.getElementById('scanner-view'),
                scannerInput: document.getElementById('scanner-input'),
                scannerSearchBtn: document.getElementById('scanner-search-btn'),
                scanFeedbackOverlay: document.getElementById('scan-feedback-overlay'),
                scanFeedbackDigits: document.getElementById('scan-feedback-digits'),
                scanFeedbackOrder: document.getElementById('scan-feedback-order'),
                scanFeedbackType: document.getElementById('scan-feedback-type'),
                scanFeedbackItems: document.getElementById('scan-feedback-items'),
                dateFilterInput: document.getElementById('date-filter-input'),
                clearDateFilter: document.getElementById('clear-date-filter'),
                cameraScanBtn: document.getElementById('camera-scan-btn'),
                cameraContainer: document.getElementById('camera-container'),
                cameraFeed: document.getElementById('camera-feed')
            };

            const toggleLoader = (show, text = '') => {
                elements.loaderText.textContent = text;
                if (show) {
                    elements.loaderOverlay.classList.add('active');
                } else {
                    elements.loaderOverlay.classList.remove('active');
                }
            };
            
            const toggleMenu = (show) => {
                elements.sideMenu.open = show;
            };

            const applyAllFilters = () => {
                updateAllViews(localShipmentsCache);
            }

            const updateAllViews = (shipments) => {
                const boxSearchTerm = elements.boxSearchInput.value.trim();
                const itemSearchTerm = elements.itemSearchInput.value.trim().toLowerCase();
                const dateFilter = elements.dateFilterInput.value;
                
                let filteredShipments = shipments;

                if (boxSearchTerm.length >= 4) {
                    filteredShipments = filteredShipments.filter(s => 
                        s.boxes.some(b => b.id.endsWith(boxSearchTerm))
                    );
                }

                if (dateFilter) {
                    const filterDate = dateFilter.split('-').reverse().join('/');
                    filteredShipments = filteredShipments.filter(s => s.shippingDate === filterDate);
                }

                if (itemSearchTerm.length >= 3) {
                    const matchingShipments = filteredShipments.map(shipment => {
                        const matchingBoxes = shipment.boxes.filter(box => 
                            box.items.some(item => 
                                item.code.toLowerCase().includes(itemSearchTerm) ||
                                item.desc.toLowerCase().includes(itemSearchTerm)
                            )
                        );
                        return { ...shipment, boxes: matchingBoxes };
                    }).filter(shipment => shipment.boxes.length > 0);
                    
                    filteredShipments = matchingShipments;
                }
                
                renderAllShipments(filteredShipments);
                generateAndRenderNotifications(localShipmentsCache);
            };

            const renderAllShipments = (shipments) => {
                if(!elements.pendingCount) return;
                
                const pendingTotal = localShipmentsCache.filter(s => initialClassifications.get(s.firestoreId) === 'pending').length;
                const partialTotal = localShipmentsCache.filter(s => initialClassifications.get(s.firestoreId) === 'partial').length;
                const completedTotal = localShipmentsCache.filter(s => initialClassifications.get(s.firestoreId) === 'completed').length;

                elements.pendingCount.textContent = pendingTotal;
                elements.partialCount.textContent = partialTotal;
                elements.completedCount.textContent = completedTotal;

                const pendingShipments = shipments.filter(s => initialClassifications.get(s.firestoreId) === 'pending');
                const partialShipments = shipments.filter(s => initialClassifications.get(s.firestoreId) === 'partial');
                const completedShipments = shipments.filter(s => initialClassifications.get(s.firestoreId) === 'completed');
                
                let listToRender;
                let emptyText = 'No hay envíos que coincidan con los filtros.';
                switch(currentStatusFilter) {
                    case 'pending': listToRender = pendingShipments; emptyText = 'No hay envíos pendientes.'; break;
                    case 'partial': listToRender = partialShipments; emptyText = 'No hay envíos parcialmente recibidos.'; break;
                    case 'completed': listToRender = completedShipments; emptyText = 'No hay envíos completados.'; break;
                }
                
                renderShipmentList(listToRender, elements.shipmentListContainer, emptyText);
                elements.managementSection.style.display = localShipmentsCache.length > 0 ? 'block' : 'none';
            };
            
            // *** FUNCIÓN CLAVE REESCRITA PARA MATERIAL ***
            const renderShipmentList = (shipmentList, container, emptyText) => {
                if(!container) return;
                container.innerHTML = '';
                
                if (shipmentList.length === 0) {
                    const p = document.createElement('p');
                    p.textContent = emptyText;
                    p.style.textAlign = 'center';
                    p.style.color = 'var(--md-sys-color-on-surface-variant)';
                    p.style.padding = '32px 0';
                    container.appendChild(p);
                    return;
                }

                const groupedByDate = shipmentList.reduce((acc, shipment) => {
                    const date = shipment.shippingDate || 'Sin Fecha';
                    if (!acc[date]) { acc[date] = []; }
                    acc[date].push(shipment);
                    return acc;
                }, {});

                const sortedDates = Object.keys(groupedByDate).sort((a, b) => {
                     const dateA = a.split('/').reverse().join('-');
                     const dateB = b.split('/').reverse().join('-');
                     return new Date(dateB) - new Date(dateA);
                });

                sortedDates.forEach(date => {
                    const dateHeader = document.createElement('h2');
                    dateHeader.className = "date-header";
                    dateHeader.textContent = date;
                    container.appendChild(dateHeader);

                    const shipmentsForDate = groupedByDate[date];
                    shipmentsForDate.sort((a, b) => (b.createdAt?.toDate?.() || 0) - (a.createdAt?.toDate?.() || 0));
                    
                    shipmentsForDate.forEach(shipment => {
                        const hasValidTimestamp = shipment.lastUpdated && typeof shipment.lastUpdated.toDate === 'function';
                        const isOverdue = hasValidTimestamp && (Date.now() - shipment.lastUpdated.toDate().getTime()) > (7 * 24 * 60 * 60 * 1000);
                        const allBoxes = shipment.boxes || [];
                        const deliveredBoxesCount = allBoxes.filter(b => b.delivered).length;
                        const isCompleted = allBoxes.length > 0 && deliveredBoxesCount === allBoxes.length;
                        const isSelected = shipmentsToDelete.has(shipment.firestoreId);
                        
                        // 1. Crear Card
                        const shipmentCard = document.createElement('div');
                        shipmentCard.className = 'shipment-card';
                        if (isSelected) shipmentCard.classList.add('is-selected');
                        if (isOverdue && !isCompleted && initialClassifications.get(shipment.firestoreId) === 'partial') {
                            shipmentCard.classList.add('is-overdue');
                        }

                        // 2. Checkbox de borrado (si aplica)
                        if (isDeleteModeActive) {
                            const checkbox = document.createElement('md-checkbox');
                            checkbox.className = 'shipment-select-checkbox';
                            checkbox.dataset.firestoreId = shipment.firestoreId;
                            checkbox.checked = isSelected;
                            checkbox.style.padding = '16px 0 16px 16px';
                            shipmentCard.appendChild(checkbox);
                        }
                        
                        // 3. Contenido de la Card
                        const content = document.createElement('div');
                        content.className = 'shipment-card-content';
                        
                        // 3a. Header de la Card
                        const header = document.createElement('div');
                        header.className = 'shipment-card-header';
                        
                        const headerInfo = document.createElement('div');
                        const title = document.createElement('h3');
                        title.className = 'shipment-card-title';
                        title.textContent = shipment.orderDescription || 'Sin Descripción';
                        headerInfo.appendChild(title);
                        
                        const subtitle = document.createElement('p');
                        subtitle.className = 'shipment-card-subtitle';
                        subtitle.textContent = `Shipping Order: ${shipment.id} | Fecha: ${shipment.shippingDate}`;
                        headerInfo.appendChild(subtitle);
                        
                        const filename = document.createElement('p');
                        filename.className = 'shipment-card-filename';
                        filename.textContent = shipment.fileName;
                        headerInfo.appendChild(filename);
                        header.appendChild(headerInfo);
                        
                        // 3b. Tags
                        const tags = document.createElement('div');
                        tags.className = 'shipment-card-tags';
                        
                        const progressChip = document.createElement('span');
                        progressChip.className = `chip ${isCompleted ? 'chip-completed' : 'chip-progress'}`;
                        progressChip.textContent = isCompleted ? 'Completado' : `Progreso: ${deliveredBoxesCount} / ${allBoxes.length}`;
                        tags.appendChild(progressChip);
                        
                        const typeChip = document.createElement('span');
                        const type = shipment.type || 'B2B';
                        typeChip.className = `chip ${type === 'Pack' ? 'chip-type-pack' : 'chip-type-b2b'}`;
                        typeChip.textContent = type;
                        tags.appendChild(typeChip);
                        header.appendChild(tags);
                        
                        content.appendChild(header);
                        
                        // 3c. Texto Overdue
                        if (isOverdue && !isCompleted && initialClassifications.get(shipment.firestoreId) === 'partial') {
                            const overdueText = document.createElement('p');
                            overdueText.className = 'overdue-text';
                            overdueText.textContent = 'Este pedido lleva más de 7 días sin actualizarse.';
                            content.appendChild(overdueText);
                        }

                        // 3d. Lista de Cajas
                        const boxListContainer = document.createElement('div');
                        boxListContainer.className = 'box-list';
                        
                        allBoxes.forEach(box => {
                            const boxItem = document.createElement('div');
                            boxItem.className = 'box-item';
                            if (box.delivered) boxItem.classList.add('is-delivered');
                            if (isDeleteModeActive) boxItem.classList.add('is-delete-mode');
                            
                            const boxCheckbox = document.createElement('md-checkbox');
                            boxCheckbox.checked = box.delivered;
                            boxCheckbox.dataset.firestoreId = shipment.firestoreId;
                            boxCheckbox.dataset.boxId = box.id;
                            if (isDeleteModeActive) boxCheckbox.disabled = true;
                            
                            const boxDetails = document.createElement('div');
                            boxDetails.className = 'box-item-details';
                            
                            const boxId = document.createElement('span');
                            boxId.className = 'box-item-id';
                            boxId.textContent = box.id;
                            boxDetails.appendChild(boxId);
                            
                            const itemsUl = document.createElement('ul');
                            itemsUl.className = 'box-item-list';
                            if ((box.items || []).length > 0) {
                                box.items.forEach(item => {
                                    const li = document.createElement('li');
                                    li.textContent = `${item.qty} x ${item.desc} (${item.size}) [${item.code}]`;
                                    itemsUl.appendChild(li);
                                });
                            } else {
                                const li = document.createElement('li');
                                li.textContent = 'No hay información de artículos para esta caja.';
                                li.style.color = 'var(--md-sys-color-outline)';
                                itemsUl.appendChild(li);
                            }
                            boxDetails.appendChild(itemsUl);
                            
                            boxItem.appendChild(boxCheckbox);
                            boxItem.appendChild(boxDetails);
                            
                            // Event listener para marcar/desmarcar
                            boxItem.addEventListener('click', (e) => {
                                if (isDeleteModeActive) return;
                                if (e.target.tagName !== 'MD-CHECKBOX') {
                                    boxCheckbox.checked = !boxCheckbox.checked;
                                    // Disparar evento de cambio manualmente
                                    boxCheckbox.dispatchEvent(new Event('change', { bubbles: true }));
                                }
                            });
                            
                            boxListContainer.appendChild(boxItem);
                        });
                        
                        content.appendChild(boxListContainer);
                        shipmentCard.appendChild(content);
                        container.appendChild(shipmentCard);
                    });
                });
            };
            
            // --- Lógica de la App (casi sin cambios) ---

            const extractDataFromPdf = async (file) => {
                pdfjsLib.GlobalWorkerOptions.workerSrc = `https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js`;
                const fileBuffer = await file.arrayBuffer();
                const pdfDoc = await pdfjsLib.getDocument({ data: fileBuffer }).promise;
                let rawTextItems = [];
                for (let i = 1; i <= pdfDoc.numPages; i++) {
                    const page = await pdfDoc.getPage(i);
                    const textContent = await page.getTextContent();
                    rawTextItems.push(...textContent.items.map(item => item.str.trim()));
                }
                
                const fullText = rawTextItems.join('\n');
                const orderIdRegex = /Shipping Order\s*([A-Z0-9]+)/i;
                const dateRegex = /Shipping date\n(\d{1,2}\/\d{1,2}\/\d{4})/;
                const descRegex = /Order Description\s*([A-Z0-9-]+)/i;
                
                const orderIdMatch = fullText.match(orderIdRegex);
                const shippingOrderId = orderIdMatch ? orderIdMatch[1] : `Desconocido-${Date.now()}`;
                
                const dateMatch = fullText.match(dateRegex);
                const shippingDate = dateMatch ? dateMatch[1] : "N/A";
                
                const descMatch = fullText.match(descRegex);
                const orderDescription = descMatch ? descMatch[1] : "Sin Descripción";
                
                const type = (orderDescription.startsWith('CS-') || orderDescription.startsWith('COS-')) ? 'Pack' : 'B2B';

                const items = [];
                const recapStartIndex = fullText.indexOf("ORDER RECAP");
                
                if (recapStartIndex > -1) {
                    const recapText = fullText.substring(recapStartIndex);
                    const lines = recapText.split('\n');
                    const itemRegex = /^([A-Z0-9]{10,12})\s+(.*?)\s+([A-Z0-9/]{1,5})\s+(\d+)\s+(ND\d{10})$/;
                    
                    for (const line of lines) {
                        const match = line.trim().match(itemRegex);
                        if (match) {
                            items.push({
                                code: match[1],
                                desc: match[2].trim().replace(/\s+/g, ' '),
                                size: match[3],
                                qty: parseInt(match[4], 10),
                                boxId: match[5]
                            });
                        }
                    }
                }

                const boxesMap = new Map();
                for (const item of items) {
                    const { boxId, ...itemData } = item;
                    if (!boxesMap.has(boxId)) {
                        boxesMap.set(boxId, { id: boxId, delivered: false, items: [] });
                    }
                    boxesMap.get(boxId).items.push(itemData);
                }

                if (items.length === 0) {
                    console.warn("No se encontró ORDER RECAP. Volviendo al escaneo de cajas simple.");
                    const boxIdRegex = /ND\d{10}/g;
                    const boxIdMatches = fullText.match(boxIdRegex);
                    const uniqueBoxIds = boxIdMatches ? [...new Set(boxIdMatches)] : [];
                    uniqueBoxIds.forEach(boxId => {
                        if (!boxesMap.has(boxId)) {
                            boxesMap.set(boxId, { id: boxId, delivered: false, items: [] });
                        }
                    });
                }
                
                const boxes = Array.from(boxesMap.values());
                return { shippingOrderId, shippingDate, boxes, orderDescription, fileName: file.name, type };
            };

            const handleFileSelect = async (files) => {
                if (!files || files.length === 0 || !shipmentsCollectionRef) return;
                toggleLoader(true, `Procesando ${files.length} archivo(s)...`);
                
                const fileProcessingPromises = Array.from(files).map(file => 
                    extractDataFromPdf(file).catch(error => { 
                        console.error(`Error procesando ${file.name}:`, error); 
                        return null; 
                    })
                );
                
                const results = await Promise.all(fileProcessingPromises);
                
                const validNewShipmentsData = results.filter(data => 
                    data && data.boxes.length > 0 && !localShipmentsCache.some(s => s.id === data.shippingOrderId)
                );
                
                if (validNewShipmentsData.length > 0) {
                    const batch = writeBatch(db);
                    validNewShipmentsData.forEach(data => {
                        const newDocRef = doc(shipmentsCollectionRef);
                        const newShipment = {
                            id: data.shippingOrderId,
                            orderDescription: data.orderDescription,
                            type: data.type,
                            fileName: data.fileName,
                            shippingDate: data.shippingDate,
                            sortableDate: data.shippingDate.split('/').reverse().join('-'),
                            boxes: data.boxes,
                            lastUpdated: serverTimestamp(),
                            createdAt: serverTimestamp()
                        };
                        batch.set(newDocRef, newShipment);
                    });
                    await batch.commit();
                }
                toggleLoader(false);
                elements.fileInput.value = null;
            };

             const generateAndRenderNotifications = (shipments) => {
                 const notifications = [];
                 const sevenDaysAgo = Date.now() - 7 * 24 * 60 * 60 * 1000;
                 
                 shipments.forEach(shipment => {
                     if (shipment.createdAt && typeof shipment.createdAt.toDate === 'function' && shipment.createdAt.toDate().getTime() < sevenDaysAgo) {
                         (shipment.boxes || []).forEach(box => {
                             if (!box.delivered) {
                                 notifications.push({
                                     id: box.id,
                                     text: `¡Atención! La caja ${box.id.slice(-7)} del pedido ${shipment.orderDescription} lleva más de 7 días sin recibirse.`
                                 });
                             }
                         });
                     }
                 });
                 
                 const uniqueNotifications = Array.from(new Map(notifications.map(n => [n.id, n])).values());

                 if (uniqueNotifications.length > 0) {
                     elements.notificationBadge.value = uniqueNotifications.length;
                     elements.notificationBadge.style.display = 'block';
                 } else {
                     elements.notificationBadge.style.display = 'none';
                 }

                 elements.notificationList.innerHTML = uniqueNotifications.length > 0 
                     ? uniqueNotifications.map(n => `<md-list-item headline="${n.text}" style="white-space: normal;"></md-list-item>`).join('')
                     : '<md-list-item headline="No hay notificaciones"></md-list-item>';
             };

            const handleCheckChange = async (event) => {
                 const target = event.target;
                 if (target.tagName === 'MD-CHECKBOX' && target.dataset.boxId && !isDeleteModeActive) {
                     const { firestoreId, boxId } = target.dataset;
                     const shipmentInCache = localShipmentsCache.find(s => s.firestoreId === firestoreId);
                     
                     if (shipmentInCache) {
                         const updatedBoxes = shipmentInCache.boxes.map(b => 
                             b.id === boxId ? { ...b, delivered: target.checked } : b
                         );
                         
                         const docRef = doc(db, shipmentsCollectionRef.path, firestoreId);
                         await updateDoc(docRef, { boxes: updatedBoxes, lastUpdated: serverTimestamp() });
                     }
                 }
            };

            const showScanFeedback = (bgColor, shipment, typeText, boxId = '') => {
                elements.scanFeedbackOverlay.style.backgroundColor = bgColor;
                let itemsHtml = '<p>No hay información de artículos.</p>';
                
                if (shipment) {
                    elements.scanFeedbackOrder.textContent = shipment.orderDescription;
                    elements.scanFeedbackDigits.textContent = shipment.orderDescription.slice(-4);
                    
                    const scannedBox = (shipment.boxes || []).find(b => b.id.slice(-7) === boxId.slice(-7));
                    if (scannedBox && scannedBox.items && scannedBox.items.length > 0) {
                        itemsHtml = '<ul>' + scannedBox.items.map(item => 
                            `<li>${item.qty} x ${item.desc} (${item.size})</li>`
                        ).join('') + '</ul>';
                    }
                } else {
                    elements.scanFeedbackOrder.textContent = 'Error';
                    elements.scanFeedbackDigits.textContent = boxId.slice(-7);
                }
                
                elements.scanFeedbackType.textContent = typeText;
                elements.scanFeedbackItems.innerHTML = itemsHtml;

                elements.scanFeedbackOverlay.classList.add('active');
                setTimeout(() => {
                    elements.scanFeedbackOverlay.classList.remove('active');
                    elements.scannerInput.focus();
                }, 2500);
            };

            const performScanSearch = async () => {
                const barcode = elements.scannerInput.value.trim();
                if (barcode.length < 7) return;

                const searchDigits = barcode.slice(-7);
                let foundBox = null;
                let foundShipment = null;

                for (const shipment of localShipmentsCache) {
                    const box = (shipment.boxes || []).find(b => b.id.slice(-7) === searchDigits);
                    if (box) {
                        foundBox = box;
                        foundShipment = shipment;
                        break;
                    }
                }

                elements.scannerInput.value = '';

                if (foundShipment && foundBox) {
                    if (foundBox.delivered) {
                        showScanFeedback('#eab308', foundShipment, 'CAJA YA RECIBIDA', foundBox.id); // Amarillo
                    } else {
                        const docRef = doc(db, shipmentsCollectionRef.path, foundShipment.firestoreId);
                        const updatedBoxes = foundShipment.boxes.map(b =>
                            b.id === foundBox.id ? { ...b, delivered: true } : b
                        );
                        await updateDoc(docRef, { boxes: updatedBoxes, lastUpdated: serverTimestamp() });
                        
                        const typeInfo = foundShipment.type === 'Pack' ? { color: '#3b82f6', label: 'PACK' } : { color: '#22c55e', label: 'B2B' };
                        showScanFeedback(typeInfo.color, foundShipment, typeInfo.label, foundBox.id);
                    }
                } else {
                    showScanFeedback('#ef4444', null, 'CAJA NO ENCONTRADA', barcode); // Rojo
                }
            };

            const stopCamera = () => {
                if (codeReader) {
                    codeReader.reset();
                }
                elements.cameraContainer.style.display = 'none';
                elements.cameraScanBtn.querySelector('span').textContent = 'Activar Cámara';
                elements.cameraScanBtn.icon = 'camera_alt';
                isCameraRunning = false;
            };

            const startCamera = async () => {
                if (!codeReader) {
                    codeReader = new BrowserMultiFormatReader();
                }
                try {
                    isCameraRunning = true;
                    elements.cameraContainer.style.display = 'block';
                    elements.cameraScanBtn.querySelector('span').textContent = 'Escaneando... (Cancelar)';
                    elements.cameraScanBtn.icon = 'stop_circle';
                    
                    const result = await codeReader.decodeOnceFromVideoDevice(undefined, 'camera-feed');
                    
                    new Audio('data:audio/wav;base64,UklGRl9vT19XQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YU'+Array(1e3).join('12112')).play();
                    elements.scannerInput.value = result.getText();
                    await performScanSearch();

                } catch (err) {
                    if (!(err instanceof NotFoundException)) {
                         console.error("Error de escaneo:", err);
                         alert("Ha ocurrido un error con la cámara. Revisa la consola y los permisos del navegador.");
                    }
                } finally {
                    stopCamera();
                }
            };
            
            const switchView = (view) => {
                if (isCameraRunning) stopCamera();
                
                document.querySelectorAll('.app-view').forEach(v => v.classList.remove('active'));
                document.getElementById(`${view}-view`).classList.add('active');
                
                // Sincronizar nav links del menú
                document.querySelectorAll('#side-menu .nav-link').forEach(l => l.active = false);
                document.getElementById(`nav-${view}`).active = true;
                
                // Sincronizar tabs de la vista principal (si es checklist)
                if (view === 'checklist') {
                    elements.statusTabs.style.display = 'flex';
                } else {
                    elements.statusTabs.style.display = 'none';
                }
            };
            
            const toggleDeleteMode = (enable) => {
                isDeleteModeActive = enable; 
                shipmentsToDelete.clear();
                
                if (enable) {
                    elements.deleteControls.classList.add('active');
                } else {
                    elements.deleteControls.classList.remove('active');
                }
                updateDeleteControls(); 
                updateAllViews(localShipmentsCache);
            };

            const updateDeleteControls = () => {
                const count = shipmentsToDelete.size;
                elements.selectionCounter.textContent = `${count} envío(s) seleccionado(s)`;
                elements.deleteSelectedButton.disabled = count === 0;
                
                const allVisibleShipments = getVisibleShipmentIds();
                const allSelected = allVisibleShipments.length > 0 && allVisibleShipments.every(id => shipmentsToDelete.has(id));
                elements.selectAllButton.textContent = allSelected ? 'Deseleccionar Todo' : 'Seleccionar Todo';
            };
            
            const handleShipmentSelect = (event) => {
                const target = event.target;
                if (isDeleteModeActive && target.classList.contains('shipment-select-checkbox')) {
                    const { firestoreId } = target.dataset;
                    if (target.checked) shipmentsToDelete.add(firestoreId); else shipmentsToDelete.delete(firestoreId);
                    updateDeleteControls(); 
                    updateAllViews(localShipmentsCache); // Re-renderizar para mostrar selección
                }
            };

            const getVisibleShipmentIds = () => {
                 const searchTerm = elements.boxSearchInput.value.trim();
                 return localShipmentsCache
                     .filter(s => searchTerm.length < 4 || s.boxes.some(b => b.id.endsWith(searchTerm)))
                     .map(s => s.firestoreId);
            };

            const handleSelectAllToggle = () => {
                const visibleShipmentIds = getVisibleShipmentIds();
                const allSelected = visibleShipmentIds.length > 0 && visibleShipmentIds.every(id => shipmentsToDelete.has(id));

                if (allSelected) {
                    visibleShipmentIds.forEach(id => shipmentsToDelete.delete(id));
                } else {
                    visibleShipmentIds.forEach(id => shipmentsToDelete.add(id));
                }
                updateDeleteControls();
                updateAllViews(localShipmentsCache);
            };

            const handleDeleteSelected = () => {
                const count = shipmentsToDelete.size; 
                if (count === 0) return;
                elements.confirmDeleteText.textContent = `¿Estás seguro de que quieres eliminar los ${count} envíos seleccionados? Esta acción no se puede deshacer.`;
                elements.confirmDeleteModal.open = true;
            };

            const executeDelete = async () => {
                toggleLoader(true, `Eliminando ${shipmentsToDelete.size} envío(s)...`);
                const batch = writeBatch(db);
                shipmentsToDelete.forEach(id => {
                    const docRef = doc(db, shipmentsCollectionRef.path, id); 
                    batch.delete(docRef);
                });
                await batch.commit();
                toggleLoader(false); 
                toggleDeleteMode(false);
                elements.confirmDeleteModal.open = false;
            };

            const connectToFirebase = async (city) => {
                toggleLoader(true, `Conectando a ${city}...`);
                currentCity = city;
                localStorage.setItem('extremaduraSportSelectedCity', city);
                elements.cityDisplay.textContent = city;
                elements.citySelectorDialog.open = false;
                elements.appWrapper.style.display = 'flex';
                
                try {
                    let app;
                    if (getApps().length === 0) {
                        app = initializeApp(firebaseConfig);
                    } else {
                        app = getApp();
                    }
                    db = getFirestore(app);
                    const auth = getAuth(app);
                    setLogLevel('error');
                    
                    if (!auth.currentUser) await signInAnonymously(auth);
                    if (unsubscribeFromShipments) unsubscribeFromShipments(); 
                    
                    const collectionPath = `projects/${projectId}/data/${city.toLowerCase()}/shipments`;
                    shipmentsCollectionRef = collection(db, collectionPath);
                    unsubscribeFromShipments = onSnapshot(shipmentsCollectionRef, (snapshot) => {
                        localShipmentsCache = snapshot.docs.map(doc => ({ firestoreId: doc.id, ...doc.data() }));
                        
                        initialClassifications.clear();
                        localShipmentsCache.forEach(s => {
                            const totalBoxes = (s.boxes || []).length;
                            const deliveredBoxes = (s.boxes || []).filter(b => b.delivered).length;
                            let status = 'pending';
                            if (deliveredBoxes === totalBoxes && totalBoxes > 0) status = 'completed';
                            else if (deliveredBoxes > 0) status = 'partial';
                            initialClassifications.set(s.firestoreId, status);
                        });

                        updateAllViews(localShipmentsCache);
                        toggleLoader(false);
                    }, error => {
                        console.error("Error de Firestore:", error);
                        alert("No se pudo conectar a la base de datos.");
                        toggleLoader(false);
                    });
                } catch (error) {
                    console.error("Firebase init failed:", error);
                    alert("Error fatal. Refresca la página.");
                    toggleLoader(false);
                }
            };
            
            // --- Función Principal (Event Listeners) ---
            
            const main = () => {
                // No mostrar la app hasta que se seleccione ciudad
                const savedCity = localStorage.getItem('extremaduraSportSelectedCity');
                if (savedCity) {
                    connectToFirebase(savedCity);
                } else {
                    elements.citySelectorDialog.open = true;
                    elements.appWrapper.style.display = 'none';
                }
                
                // Listeners de Selección de Ciudad
                document.getElementById('caceres-btn').addEventListener('click', () => connectToFirebase('Cáceres'));
                document.getElementById('badajoz-btn').addEventListener('click', () => connectToFirebase('Badajoz'));

                // Listeners del Menú
                elements.openMenuButton.addEventListener('click', () => toggleMenu(true));
                elements.changeCityButton.addEventListener('click', () => {
                    localStorage.removeItem('extremaduraSportSelectedCity');
                    location.reload();
                });

                // Listeners de Vistas y Filtros
                elements.navChecklist.addEventListener('click', (e) => { switchView('checklist'); toggleMenu(false); });
                elements.navScanner.addEventListener('click', (e) => { switchView('scanner'); toggleMenu(false); });
                
                elements.statusFilters.addEventListener('click', (e) => {
                     const link = e.target.closest('md-list-item');
                     if(link && link.dataset.filter){
                        currentStatusFilter = link.dataset.filter;
                        // Sincronizar Tabs con Menú
                        elements.statusTabs.activeTabIndex = Array.from(elements.statusTabs.tabs).findIndex(t => t.dataset.filter === currentStatusFilter);
                        elements.statusFilters.querySelectorAll('.filter-link').forEach(a => a.active = false);
                        link.active = true;
                        
                        if (elements.scannerView.classList.contains('active')) switchView('checklist');
                        updateAllViews(localShipmentsCache);
                        toggleMenu(false);
                     }
                });
                
                elements.statusTabs.addEventListener('change', (e) => {
                    currentStatusFilter = e.target.activeTab.dataset.filter;
                    // Sincronizar Menú con Tabs
                    elements.statusFilters.querySelectorAll('.filter-link').forEach(a => a.active = (a.dataset.filter === currentStatusFilter));
                    updateAllViews(localShipmentsCache);
                });

                // Listeners de Carga de Archivos
                elements.uploadButton.addEventListener('click', () => elements.fileInput.click());
                elements.fileInput.addEventListener('change', (event) => handleFileSelect(event.target.files));
                
                // Listeners de Gestión (Borrado)
                elements.manageShipmentsButton.addEventListener('click', () => toggleDeleteMode(true));
                elements.cancelDeleteButton.addEventListener('click', () => toggleDeleteMode(false));
                elements.deleteSelectedButton.addEventListener('click', handleDeleteSelected);
                elements.selectAllButton.addEventListener('click', handleSelectAllToggle);
                elements.confirmDeleteModal.addEventListener('close', (e) => {
                    if (e.target.returnValue === 'delete') executeDelete();
                });
                
                // Listeners de Filtros de Búsqueda
                elements.itemSearchInput.addEventListener('input', applyAllFilters);
                elements.boxSearchInput.addEventListener('input', applyAllFilters);
                elements.dateFilterInput.addEventListener('change', applyAllFilters);
                elements.clearDateFilter.addEventListener('click', () => {
                    elements.dateFilterInput.value = '';
                    elements.itemSearchInput.value = '';
                    elements.boxSearchInput.value = '';
                    applyAllFilters();
                });
                
                // Listeners de Escáner
                elements.scannerInput.addEventListener('input', () => {
                    clearTimeout(scanTimeout);
                    scanTimeout = setTimeout(performScanSearch, 1500);
                });
                elements.scannerSearchBtn.addEventListener('click', () => {
                    clearTimeout(scanTimeout);
                    performScanSearch();
                });
                elements.cameraScanBtn.addEventListener('click', () => {
                    if (isCameraRunning) stopCamera(); else startCamera();
                });

                // Listeners de Notificaciones
                elements.notificationBell.addEventListener('click', () => elements.notificationPanel.open = !elements.notificationPanel.open);
                elements.clearNotificationsBtn.addEventListener('click', () => {
                    elements.notificationList.innerHTML = '<md-list-item headline="No hay notificaciones"></md-list-item>';
                    elements.notificationBadge.style.display = 'none';
                    elements.notificationPanel.open = false;
                });

                // Listeners Globales
                document.body.addEventListener('change', (e) => { handleCheckChange(e); handleShipmentSelect(e); });
            };

            main();
        });
    </script>
</body>
</html>